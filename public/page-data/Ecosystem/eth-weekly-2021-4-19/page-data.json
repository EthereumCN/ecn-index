{"componentChunkName":"component---src-template-article-js","path":"/Ecosystem/eth-weekly-2021-4-19/","result":{"data":{"strapiArticles":{"title":"以太七日谈 • 2021/4/19","summary":"柏林硬分叉故障详析、Chainlink 2.0 白皮书","publishDate":"2021-04-19","author":"ECN","authorImg":{"childImageSharp":{"fixed":{"src":"/static/18e33ca02b0130c3f952c7a725931e7a/497c6/ac7e303d9bcf9058c207ba55f49192bb.png"}}},"content":"![22](https://i.ibb.co/HdWDLxn/cover.png)\n\n<br/>\n\n# Eth1\n\n**柏林升级故障回顾**\n\n 在柏林升级中，客户端 OpenEthereum 引起以太坊网络一些重要服务故障，以下为以太坊研究员 Alex Stokes @ralexstokes 对此次事件详析的编译：\n\n首先想对@OpenEthereumOrg 的快速反应和漏洞修复表示感谢。\n\n事件起源于这一笔交易：https://etherscan.io/tx/0x7006f38fa2e6654fae1a781aefc5885fe0cb8f778b1add10636eaf7e34279247\n\n这笔交易是一次合约调用，从 KuCoin 交易所给一系列地址支付 ETH。问题的根源在于交易调用数据的 ABI (二进制接口) 编码存在漏洞，这导致出现共识问题。大家可以看看 Etherscan 上的“输入数据”：\n\n![input1](https://i.ibb.co/Tm6LmN5/input1.png)\n\n![input2](https://i.ibb.co/c3D4VWj/input2.png)\n\n![input3](https://i.ibb.co/j33KR1n/input3.png)\n\n1. 我们在合约上调用 `sendEths` 有两个参数，一个是大小动态变化的目标地址数组，另一个是大小动态变化的数值数组 (以 wei 为单位)，以此来指定把多少 ETH 发送给谁。\n\n2. 我们可以对调用数据进行解析，看看是哪里出问题：第一行 (Etherscan 上的第一行，标记为[0]) 显示地址列表以 64 byte 开始 ([2]那一行)。第二行表明列表的数值从 416 byte 开始（[13]那一行)。\n\n3. 也就是说，我们可以推测这个列表的数据是成对循环的，依次向每个地址发送 ETH。到这里似乎道理挺简单的。\n\n4. 如果我们开始迭代这个列表，我们首先进行的是调用数据的正确位组，Solidity 的 ABI 规定大小动态变化数组的长度构成数据的第一部分。\n\n5. 这就是故障的根源，因为调用数据的值是`0x10`——十六进制。但是调用数据只给了 10 个地址/数值对。调用数据的正确 ABI 编码应该是 [2] 和 [13] 的数值为`0xA`，而不是 `0x10`！\n\n6. 你可能已经猜到在这里出现了什么问题，我们可以回到这笔交易的执行记录看看发生了什么：https://etherscan.io/vmtrace?txhash=0x7006f38fa2e6654fae1a781aefc5885fe0cb8f778b1add10636eaf7e34279247&type=parity\n\n7. 合约成功迭代前10对数据，它应该在这里就停下来，但根据调用数据，有多于10个地址，也就是说前10对数据后它继续迭代。但根据调用数据的结构，第11个地址是列表长度编码`0x10`。也就是说合约尝试给地址 `0x10` 发送 0 个 ETH。\n\n![bug](https://i.ibb.co/tQZMG17/wrong.png)\n\n8. 另外：如果合约尝试读取不存在的调用数据，它似乎会返回 0 个 ETH——你可以想象该合约在这里出错，但它却继续再给 6 个从调用数据“读取”的地址发送 0 个 ETH。\n\n此时，你可能会注意到，`0x10` 是一个有点“特殊的地址”，因为它正好在 EVM 预编译的范围内 （像大多数在 EVM 汇编之外有优化实现的特殊合约一样）。我们不必预期预编译 `0x10` 能够返回 ETH，尽管它发送的 ETH 可能会石沉大海，但这不一定会造成比漏洞合约更严重的问题。那为什么它会导致整个客户端出问题呢？\n\n原因在于 `0x10` 实际上是 EIP-2537 对 BLS 成对加密例程的预编译，但这个 EIP 还未在主网部署。因此尽管你可以与该地址交互，在主网上也没有合约代码进一步执行。\n\n我们还需要另一件事来解释这个问题，你可能猜到与柏林因分叉有关：柏林部署了 EIP-2929，这份 EIP 会改变 EVM 里 gas 的计算。\n\n在 EIP-2929 下，在你第一次执行一些存储操作码时需要支付更多，但当你往后在同一笔交易里访问相同的实体时，则支付更少的 gas。这个重新定价机制现在应该能更准确地反映改变客户端存储的成本，并承认在任何客户端执行过程中，这些数据通常被缓存在更便宜的硬件层中。\n\n要解释预编译的特殊性，EIP-2929 详细说明 EVM 会对被访问过合约的调用进行分辨，以反映预编译一般不需要动用昂贵的存储资源。\n\n现在我们终于可以回到 OpenEthereum 在 \\#12244294 区块的漏洞——客户端把所有执行了的预编译加入到 EIP-2929 的访问列表里。因为 EIP-2537 已经在大多数客户端里实现了 (曾经说要纳入柏林硬分叉！) ，所以 OpenEthereum 对任何像上面这样访问  `0x10` 的交易给了 gas 费折扣。\n\n看来，客户端对 EIP-2929 的实现各不相同，并只给活跃的预编译 gas 费折扣，而 EIP-2537 的预编译实际上还未启动！因此 OpenEthereum 得出的 gas 数与其他客户端不一样。\n\n来源：https://twitter.com/ralexstokes/status/1382750001026146304?s=20\n\n事件发生后，核心开发者在 4.17 的 AllCoreDev 作出事后检讨，会上讨论内容包括 hive test suite 可以使用更多接近主网的配置文档、需要更好的 debug 工具、对把不良区块导入客户端并进行分析的支持对这种事情很有帮助等。还有一个原因是 OpenEthereum 现在由一个比较新的团队在运维，需要处理非常复杂的代码库和遗留问题。\n\n来源：https://twitter.com/TimBeiko/status/1383054611506864133?s=20\n\n另外，Ethereum Cat Herder 创始人 Pooja Ranjan 在Github 发表了整个柏林升级的回顾，包括准备、启动、纠错的过程。\n\n文章详情：https://github.com/ethereum/eth1.0-specs/blob/master/network-upgrades/retrospectives/berlin.md\n\n\n<br/>\n\n**伦敦升级进度**\n\n4.17 的AllCoreDev 对 Aleut (只涵盖 EIP-1559 和 3198）以后的测试网还需要添加哪些内容进行讨论，这部分内容又涉及是否伦敦升级后就进行“合并”，讨论的重点包括：\n\n1. 如果伦敦后就集中在“合并”上，那么很大机会伦敦一年后才会有一个“功能分叉 (feature fork)\"；\n2. 1559 本身的内容就很多，在社区呼声很高，且由于难度炸弹的原因必须在这个夏天实现；\n3. 各个客户端团队无法做到同步推进工作，因此在添加内容到升级时需要注意这一点，基于此，大家同意伦敦至少需要包括1559、3198、以及难度炸弹推迟；\n4. 关于其他 EIP (EIP-3403、EIP-3074、EIP-2537、EIP-2677)，我们应该看它们会给客户端带来多少工作，以及它们能提供多少价值。感觉 EIP-3403 和 EIP-3074 是大家最想要的。\n\n由于伦敦升级近在眼前，还有很多事情需要做决定，会议决定 4 月 23 日安排一次额外会议，议程如下：\n\n![agenda](https://i.ibb.co/5rJNCvD/agenda.png)\n\n<br/>\n\n# Eth2\n\n北京时间 2021 年 4 月19 日 17:20:23 迎来了信标链第 1,000,000 个 slot!\n\n<br/>\n\n# Layer2\n\n**Matter Labs 团队介绍新解决方案 zkPorter**\n\n以太坊二层解决方案团队 Matter Labs 表示，在 zkSync 2.0 中， L2 状态将会分成两个部分：数据可用性在链上的 zkRollup 和数据可用性在链下的 zkPorter，用户可以自行选择将自己的资金存储于链上还是链下。关于 zkPorter 的详细介绍，请阅读《zkPorter: L2 扩容的突破》。\n\n随后，Vitalik 在 reddit 中提出对于本篇文章的质疑，认为 “zkPorter 有着比 Optimistic rollups 更强的安全保障” 这一说法并不恰当，zkSync 方回复了 Vitalik 的质疑。详细请看文章。\n\n来源：https://medium.com/matter-labs/zkporter-a-breakthrough-in-l2-scaling-ed5e48842fbf\n\n<br/>\n\n# 生态\n\n**Chainlink 2.0 白皮书发布**\n\n4 月 15 日，chainlink 发布 2.0 版本白皮书：去中心化预言机网络发展的下一步。除了 Chainlink 目前所提供的外部数据之外，该版新白皮书概述了 Chainlink 将如何发展去中心化预言机网络，如何继续创建一个去中心化元层，通过提供高度的可扩展性、机密性以及安全的链下计算方式，来提高智能合约。\n\nChainlink 2.0 白皮书介绍了一种用于构建混合智能合约的新架构，其中去中心化预言机网络提供了区块链无法提供的关键功能。它作为一个安全的链下计算层，部分依赖于区块链以实现安全性，但在运作时同时利用链下系统的可连接性、功能丰富性和可扩展性。这个新的抽象层将使得 Chainlink 为大量安全的、功能丰富的智能合约应用程序提供支持，并且为更广泛的用户和应用案例提供支持。\n\n![Chainlink Decentralized Oracle Networks](https://i.ibb.co/FW7GTYF/chainlink.png)\n\n图：去中心化预言机网络允许智能合约应用程序访问任何链下数据源或计算\n\n\n\n白皮书：https://research.chain.link/whitepaper-v2.pdf?_ga=2.76399382.2026745185.1618821757-725326390.1609159043\n\n来源：https://blog.chain.link/chainlink-2-0-lays-foundation-for-adoption-of-hybrid-smart-contracts/\n\n<br/>\n\n**斯诺登肖像 NFT 以 2224 ETH 价格成功拍卖**\n\n基于前美国中央情报局职员、“棱镜计划”披露者爱德华 · 斯诺登的肖像的 NFT 作品 ”Stay Free“，以 2224 ETH 的价格在 NFT 制作和交易平台 Foundation 成功拍卖，拍卖者为新闻自由基金会 ”Freedom of the Press Foundation“，竞得者为去中心化组织 PleasrDAO。\n\n该 NFT 使用开源软件制作，背景画面为当年对美国国家安全局的大规模监控计划的标志性法庭裁决书，中间的肖像为斯诺登，摄影师为 Platon。其拍卖收益将全部捐献给新闻自由基金会，旨在资助和支持言论自由和新闻自由，主席为斯诺登。\n\n![nft](https://i.ibb.co/H4kSp08/snowden.png)\n\ncr: foundation.app，”Stay Free“\n\n来源：https://foundation.app/Snowden/stay-free-edward-snowden-2021-24437\n\n<br/>\n\n**以太坊生态活动预告**\n\n- 4 月 23 日 至 5 月 30 日\n\n  imToken 将联合 ETHPlanet、EthFans、ECN、上海前沿技术研讨会和 HiBlock 等以太坊社区和项目，举办六场以扩容为主题的活动，形式有：Meetup + Workshop + AMA + Hackathon。\n\n  本次系列活动网站：https://rollup.world\n\n  第一场活动 (4月23日) 即将开始：Rollup - 以太坊 L2 扩容新范式杭州线下 Meetup。\n\n  报名方式：点进文章《线下 Meetup 活动｜Rollup - 以太坊 L2 扩容新范式》，点击文末「阅读原文」扫码报名 Meetup 活动。\n\n\n\n- 4 月 22 日，以太坊企业会议2021展望\n\n  以太坊各个领域的企业将聚首 ”Ethereum in the Enterprise 2021“ 共同探讨以太坊主网、Layer2、Eth2.0、隐私、安全等主题。\n\n  会议链接：https://www.conference2021.entethalliance.org/\n\n","cover":{"childImageSharp":{"resize":{"src":"/static/66a1b01256795a8db63db75f4e581724/497c6/a8ac179452d4a65b2def3f67474e5186.png"}}}},"site":{"siteMetadata":{"title":"Ethereum Community Network","description":"以太坊——全球的、开源的去中心化应用平台。DeFi？NFT？游戏？虚拟世界？每一个人都可以成为以太坊的开发者和用户！","author":"@ECN以太坊社区网络","keywords":"以太坊,以太坊中国,Ethereum","siteLanguage":"zh-CN","siteLocale":"zh-cn","siteUrl":"http://ethereum.cn","twitterUsername":"@EthereumCN"}}},"pageContext":{"id":"Articles_246"}},"staticQueryHashes":["1238767529","2940180826"]}